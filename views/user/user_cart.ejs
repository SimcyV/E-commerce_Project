
<%- include('../partials/signedin_header') %>


 <!-- Breadcrumbs -->
 <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item" aria-current="page"><a href="/cart">Cart</a></li>
    </ol>
</nav>
<!-- end of breadcrumb -->





 <!-- ...................................................................... -->
 <div class="container-fluid" style="min-height: 65vh;">
    <div class="row p-1">
        <div class="col-md-8 p-3">
            <h3 class="fw-bold text-secondary">Cart Page</h3>
            <hr>
            <% if (messages.success) { %>
                <div class="alert alert-success">
                    <%= messages.success %>
                </div>
            <% }else if (messages.error){ %>
              <div class="alert alert-danger">
                <%= messages.error %>
            </div>
            <%}%>
            <div class="bg-white rounded shadow-sm border d-flex justify-content-between align-items-left my-1">
                <table class="table table-borderless m-0">
                        <% if (newCart && newCart.items.length > 0) { %>
                            <% newCart.items.forEach((x) => { %>
                        <tr class="border">
                            <th class="text-center">
                                    <img src="/uploads/<%= x.productId.images[0]%>" alt="Product-image" class="img-fluid" style="height: 100px; width: auto;"></th>
                            <th>
                                <p class="fw-bold m-1"><%= x.productId.name %></p>
                                <div class="d-flex  align-items-left p-2">
                                    <button class="btn btn-outline-dark p-1 px-3" onclick="quantityChanger('<%= x.productId._id %>',-1,'<%=newCart._id%>')">-</button>                                        
                                    <p class="fw-bold m-0 px-2 p-1" id="quantity_<%= x.productId._id %>"><%= x.quantity %></p>
                                    <button class="btn btn-outline-dark me-3" onclick="quantityChanger('<%= x.productId._id %>',1,'<%=newCart._id%>')">+</button>
                                 
                                </div>
                            </th>
                            
                                                           
                                <% if (x.productId.offerprice===0) { %>
                                    <th><p class="fw-bold text-secondary my-4">Rs <%= x.quantity * (x.productId.price-x.productId.discount) %></p></th>                                 
                                <% } else { %>
                                    <th><p class="fw-bold text-secondary my-4">Rs <%= x.quantity * (x.productId.offerprice) %></p></th> 
                                    <%}%>
                                
                              
                            
                            <th><a href="/removeCartItems/<%=x.productId._id%>"><button class="btn btn-outline-dark p-1 px-3 my-4 fw-bold" onclick="return confirm('Are you sure to delete the item')">Remove</button></a>
                                </th>                               
                                <!-- <th><a href="" class="btn btn-outline-dark p-1 px-3 my-4 fw-bold" >Remove</a></th> -->                                      
                        </tr>
                        <% }) %>  
                        <% }else{ %>
                            <tr>
                                <th>
                                    <h3 class="alert alert-danger w-50 m-auto my-5 text-center">No Items Found</h3>
                                    <div class="text-center">
                                        <a href="/dashboard"><button>Add Products</button></a>
                                    </div>
                                </th>
                            </tr>
                            <%}%>
                    </table>
                </div> 
        </div>
        <div class="col-md-4 p-3">
            <div class="p-5 bg-white shadow-sm">
                <h4 class="fw-bold">SUMMARY</h4>
                <hr>
                <div class="d-flex justify-content-between">
                    <p class="text-secondary">Price</p>
                    <p class="text-secondary fw-bold">Rs <%= total %></p>
                </div>
                <div class="d-flex justify-content-between">
                    <p class="text-secondary">No of items</p> 
                    <p class="text-secondary"><%= totalQuantity %></p>                            
                </div>
                <div class="d-flex justify-content-between">
                    <p class="text-secondary">Delivery Fee</p>
                    <!-- <p class="text-secondary fw-bold">$ 0</p> -->
                    <p class="text-secondary fw-bold">Free</p>
                    <!-- <p class="text-secondary fw-bold">$ 250.00</p> -->
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <p class="fw-bold">Total Amount</p>
                    <p class="fw-bold">Rs <%= total %></p>
                </div>
                <div class="d-flex justify-content-end">
                    <% if (newCart && newCart.items.length > 0) { %>
                        <a href="/checkOut" class="btn btn-outline-primary">Checkout</a>                         
                    <% } %>
                    
                </div>
            </div>
        </div>
    </div>
</div>  
<!-- ......................................................................................... -->

<script>
    function quantityChanger(productId, count, cartId) {    
        console.log(productId, count, cartId); 
      var quantityElement = document.getElementById("quantity_" + productId);
      var totalQuantityElement = document.getElementById("totalQuantity");
      var currentQuantity = parseInt(quantityElement.innerText, 10)
      if (count === 1) {
        currentQuantity += 1;
        quantityElement.innerText = currentQuantity;        
      } else if (count === -1 && currentQuantity > 1) {
        currentQuantity -= 1;
        quantityElement.innerText = currentQuantity;        
      }
        

      $.ajax({
       
        
        url:'/updateQuantity',
        method:'POST',
        data:{
            productId:productId,
            quantity:currentQuantity,
            carts:cartId
        },
        success : function (Response) {                
            if(Response.success){
                totalQuantityElement.innerText = Response.totalQuantity;
                // alert('quantity updated');              

                location.reload()
            }else{ 
                alert('you exeeded the limit');
                location.reload()
            }
        }
      })
    }


    
   </script>

   <%- include('../partials/footer') %>
 
      
   






   





